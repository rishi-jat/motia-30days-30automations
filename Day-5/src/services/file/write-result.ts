/**
 * File Writing Service
 * Writes tweet results to TWEET_RESULT.md
 */

import { writeFile } from 'fs/promises';
import { FileWriteError } from '../../errors/tweet-errors.js';
import type { TweetVariation } from '../ai/generate-tweet.js';
import type { TweetResult } from '../xapi/types.js';

export interface TweetResultData {
    originalIdea: string;
    variations: TweetVariation[];
    selectedTweet: TweetVariation;
    postResult: TweetResult;
}

/**
 * Write tweet result to markdown file
 */
export async function writeTweetResult(data: TweetResultData): Promise<void> {
    try {
        const outputPath = process.env.OUTPUT_PATH || './TWEET_RESULT.md';

        const markdown = generateMarkdown(data);

        await writeFile(outputPath, markdown, 'utf-8');
    } catch (error) {
        throw new FileWriteError(
            `Failed to write result file: ${error instanceof Error ? error.message : 'Unknown error'}`
        );
    }
}

/**
 * Generate markdown content for the result file
 */
function generateMarkdown(data: TweetResultData): string {
    const { originalIdea, variations, selectedTweet, postResult } = data;

    return `# üê¶ Tweet Result

## Original Idea
\`\`\`
${originalIdea}
\`\`\`

---

## Generated Variations

### Variation 1
**Length:** ${variations[0].length} chars | **Has Hashtags:** ${variations[0].hasHashtags ? 'Yes' : 'No'}

\`\`\`
${variations[0].text}
\`\`\`

### Variation 2
**Length:** ${variations[1].length} chars | **Has Hashtags:** ${variations[1].hasHashtags ? 'Yes' : 'No'}

\`\`\`
${variations[1].text}
\`\`\`

### Variation 3
**Length:** ${variations[2].length} chars | **Has Hashtags:** ${variations[2].hasHashtags ? 'Yes' : 'No'}

\`\`\`
${variations[2].text}
\`\`\`

---

## ‚úÖ Selected Tweet (Best)
**Length:** ${selectedTweet.length} chars | **Has Hashtags:** ${selectedTweet.hasHashtags ? 'Yes' : 'No'}

\`\`\`
${selectedTweet.text}
\`\`\`

---

## üöÄ Post Result

- **Tweet ID:** \`${postResult.tweetId}\`
- **Tweet URL:** ${postResult.tweetUrl}
- **Posted At:** ${postResult.timestamp}
- **Mock Mode:** ${postResult.isMock ? '‚úÖ Yes (Testing)' : '‚ùå No (Real Post)'}

---

**Generated by Day-5 AI X Auto-Posting Workflow** ü§ñ
`;
}
